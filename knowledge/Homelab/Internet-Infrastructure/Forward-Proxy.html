<!DOCTYPE html>
<html lang="en"><head><title>Forward Proxy</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains Mono&amp;family=Open Sans:wght@400;700&amp;family=Open Sans:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="one137"/><meta property="og:title" content="Forward Proxy"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Forward Proxy"/><meta name="twitter:description" content="A forward proxy sits between users and the internet, acting as an intermediary for outbound requests. When users want to access external websites, their traffic goes through the forward proxy first."/><meta property="og:description" content="A forward proxy sits between users and the internet, acting as an intermediary for outbound requests. When users want to access external websites, their traffic goes through the forward proxy first."/><meta property="og:image:type" content="image/webp"/><meta property="og:image:alt" content="A forward proxy sits between users and the internet, acting as an intermediary for outbound requests. When users want to access external websites, their traffic goes through the forward proxy first."/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:image:url" content="https://one137.dev/knowledge/static/og-image.png"/><meta name="twitter:image" content="https://one137.dev/knowledge/static/og-image.png"/><meta property="og:image" content="https://one137.dev/knowledge/static/og-image.png"/><meta property="twitter:domain" content="one137.dev/knowledge"/><meta property="og:url" content="https://one137.dev/knowledge/Homelab/Internet-Infrastructure/Forward-Proxy"/><meta property="twitter:url" content="https://one137.dev/knowledge/Homelab/Internet-Infrastructure/Forward-Proxy"/><link rel="icon" href="../../static/icon.png"/><meta name="description" content="A forward proxy sits between users and the internet, acting as an intermediary for outbound requests. When users want to access external websites, their traffic goes through the forward proxy first."/><meta name="generator" content="Quartz"/><link href="../../index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="../../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../../static/contentIndex.json").then(data => data.json())</script></head><body data-slug="Homelab/Internet-Infrastructure/Forward-Proxy"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href="../..">one137</a></h2><div class="spacer mobile-only"></div><div class="search"><button class="search-button" id="search-button"><p>Search</p><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></button><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div><div><span>Theme:  </span><button class="darkmode" id="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button></div><div class="explorer desktop-only"><button type="button" id="explorer" data-behavior="collapse" data-collapsed="collapsed" data-savestate="true" data-tree="[{&quot;path&quot;:&quot;Homelab&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Homelab/Internet-Infrastructure&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Homelab/Internet-Infrastructure/Introductory-presentation&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Homelab/OS-and-Virtualization&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Homelab/Public-website&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Homelab/Security&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Homelab/Services&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Homelab/Storage&quot;,&quot;collapsed&quot;:true}]" aria-controls="explorer-content" aria-expanded="false"><h2>Explorer</h2><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="explorer-content"><ul class="overflow" id="explorer-ul"><li><div class="folder-outer open"><ul style="padding-left:0;" class="content" data-folderul><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Homelab"><button class="folder-button"><span class="folder-title">Homelab</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Homelab"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Homelab/Internet-Infrastructure"><button class="folder-button"><span class="folder-title">Internet Infrastructure</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Homelab/Internet-Infrastructure"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Homelab/Internet-Infrastructure/Introductory-presentation"><button class="folder-button"><span class="folder-title">Introductory presentation</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Homelab/Internet-Infrastructure/Introductory-presentation"><li><a href="../../Homelab/Internet-Infrastructure/Introductory-presentation/1-–-IP,-Routes,-Subnets" data-for="Homelab/Internet-Infrastructure/Introductory-presentation/1-–-IP,-Routes,-Subnets">1 – IP, Routes, Subnets</a></li><li><a href="../../Homelab/Internet-Infrastructure/Introductory-presentation/2-–-Domains-and-DNS" data-for="Homelab/Internet-Infrastructure/Introductory-presentation/2-–-Domains-and-DNS">2 – Domains and DNS</a></li></ul></div></li><li><a href="../../Homelab/Internet-Infrastructure/Cloudflare" data-for="Homelab/Internet-Infrastructure/Cloudflare">Cloudflare</a></li><li><a href="../../Homelab/Internet-Infrastructure/Forward-Proxy" data-for="Homelab/Internet-Infrastructure/Forward-Proxy">Forward Proxy</a></li><li><a href="../../Homelab/Internet-Infrastructure/Reverse-Proxy" data-for="Homelab/Internet-Infrastructure/Reverse-Proxy">Reverse Proxy</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Homelab/OS-and-Virtualization"><button class="folder-button"><span class="folder-title">OS and Virtualization</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Homelab/OS-and-Virtualization"><li><a href="../../Homelab/OS-and-Virtualization/Alpine-(Distro)" data-for="Homelab/OS-and-Virtualization/Alpine-(Distro)">Alpine (Distro)</a></li><li><a href="../../Homelab/OS-and-Virtualization/Debian" data-for="Homelab/OS-and-Virtualization/Debian">Debian</a></li><li><a href="../../Homelab/OS-and-Virtualization/Docker" data-for="Homelab/OS-and-Virtualization/Docker">Docker</a></li><li><a href="../../Homelab/OS-and-Virtualization/Kali-Linux" data-for="Homelab/OS-and-Virtualization/Kali-Linux">Kali Linux</a></li><li><a href="../../Homelab/OS-and-Virtualization/Linux-Systems-Setup" data-for="Homelab/OS-and-Virtualization/Linux-Systems-Setup">Linux Systems Setup</a></li><li><a href="../../Homelab/OS-and-Virtualization/LXC" data-for="Homelab/OS-and-Virtualization/LXC">LXC</a></li><li><a href="../../Homelab/OS-and-Virtualization/Proxmox" data-for="Homelab/OS-and-Virtualization/Proxmox">Proxmox</a></li><li><a href="../../Homelab/OS-and-Virtualization/Remote-Graphical-OS-Access" data-for="Homelab/OS-and-Virtualization/Remote-Graphical-OS-Access">Remote Graphical OS Access</a></li><li><a href="../../Homelab/OS-and-Virtualization/TrueNAS" data-for="Homelab/OS-and-Virtualization/TrueNAS">TrueNAS</a></li><li><a href="../../Homelab/OS-and-Virtualization/Virtualization" data-for="Homelab/OS-and-Virtualization/Virtualization">Virtualization</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Homelab/Public-website"><button class="folder-button"><span class="folder-title">Public website</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Homelab/Public-website"><li><a href="../../Homelab/Public-website/Comments-API" data-for="Homelab/Public-website/Comments-API">Comments API</a></li><li><a href="../../Homelab/Public-website/Continuous-Delivery" data-for="Homelab/Public-website/Continuous-Delivery">Continuous Delivery</a></li><li><a href="../../Homelab/Public-website/Obsidian-Vault-to-Wiki" data-for="Homelab/Public-website/Obsidian-Vault-to-Wiki">Obsidian Vault to Wiki</a></li><li><a href="../../Homelab/Public-website/Public-Website" data-for="Homelab/Public-website/Public-Website">Public Website</a></li><li><a href="../../Homelab/Public-website/Serve-static-files-through-NPM" data-for="Homelab/Public-website/Serve-static-files-through-NPM">Serve static files through NPM</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Homelab/Security"><button class="folder-button"><span class="folder-title">Security</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Homelab/Security"><li><a href="../../Homelab/Security/fail2ban" data-for="Homelab/Security/fail2ban">fail2ban</a></li><li><a href="../../Homelab/Security/Homelab-Security" data-for="Homelab/Security/Homelab-Security">Homelab Security</a></li><li><a href="../../Homelab/Security/Security---Cryptography" data-for="Homelab/Security/Security---Cryptography">Security - Cryptography</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Homelab/Services"><button class="folder-button"><span class="folder-title">Services</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Homelab/Services"><li><a href="../../Homelab/Services/Cloudflared" data-for="Homelab/Services/Cloudflared">Cloudflared</a></li><li><a href="../../Homelab/Services/ddclient" data-for="Homelab/Services/ddclient">ddclient</a></li><li><a href="../../Homelab/Services/Diun" data-for="Homelab/Services/Diun">Diun</a></li><li><a href="../../Homelab/Services/DNSMasq" data-for="Homelab/Services/DNSMasq">DNSMasq</a></li><li><a href="../../Homelab/Services/Healthchecks" data-for="Homelab/Services/Healthchecks">Healthchecks</a></li><li><a href="../../Homelab/Services/Homelab-Networking" data-for="Homelab/Services/Homelab-Networking">Homelab Networking</a></li><li><a href="../../Homelab/Services/Homelab-Services" data-for="Homelab/Services/Homelab-Services">Homelab Services</a></li><li><a href="../../Homelab/Services/Jellyfin" data-for="Homelab/Services/Jellyfin">Jellyfin</a></li><li><a href="../../Homelab/Services/Mailrise" data-for="Homelab/Services/Mailrise">Mailrise</a></li><li><a href="../../Homelab/Services/MongoDB" data-for="Homelab/Services/MongoDB">MongoDB</a></li><li><a href="../../Homelab/Services/Nginx-Proxy-Manager-(NPM)" data-for="Homelab/Services/Nginx-Proxy-Manager-(NPM)">Nginx Proxy Manager (NPM)</a></li><li><a href="../../Homelab/Services/Pi-Hole" data-for="Homelab/Services/Pi-Hole">Pi-Hole</a></li><li><a href="../../Homelab/Services/Portainer" data-for="Homelab/Services/Portainer">Portainer</a></li><li><a href="../../Homelab/Services/Syncthing" data-for="Homelab/Services/Syncthing">Syncthing</a></li><li><a href="../../Homelab/Services/Transmission" data-for="Homelab/Services/Transmission">Transmission</a></li><li><a href="../../Homelab/Services/Uptime-Kuma" data-for="Homelab/Services/Uptime-Kuma">Uptime-Kuma</a></li><li><a href="../../Homelab/Services/Watchtower" data-for="Homelab/Services/Watchtower">Watchtower</a></li><li><a href="../../Homelab/Services/Wireguard" data-for="Homelab/Services/Wireguard">Wireguard</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Homelab/Storage"><button class="folder-button"><span class="folder-title">Storage</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Homelab/Storage"><li><a href="../../Homelab/Storage/iSCSI" data-for="Homelab/Storage/iSCSI">iSCSI</a></li><li><a href="../../Homelab/Storage/NAS-Data-Protection" data-for="Homelab/Storage/NAS-Data-Protection">NAS Data Protection</a></li><li><a href="../../Homelab/Storage/Network-Shares" data-for="Homelab/Storage/Network-Shares">Network Shares</a></li><li><a href="../../Homelab/Storage/NVMe" data-for="Homelab/Storage/NVMe">NVMe</a></li><li><a href="../../Homelab/Storage/PCIe" data-for="Homelab/Storage/PCIe">PCIe</a></li><li><a href="../../Homelab/Storage/SATA" data-for="Homelab/Storage/SATA">SATA</a></li><li><a href="../../Homelab/Storage/SCSI" data-for="Homelab/Storage/SCSI">SCSI</a></li><li><a href="../../Homelab/Storage/SCSI-vs-NVMe-vs-AHCI-(SATA)" data-for="Homelab/Storage/SCSI-vs-NVMe-vs-AHCI-(SATA)">SCSI vs NVMe vs AHCI (SATA)</a></li><li><a href="../../Homelab/Storage/XFS" data-for="Homelab/Storage/XFS">XFS</a></li><li><a href="../../Homelab/Storage/ZFS" data-for="Homelab/Storage/ZFS">ZFS</a></li><li><a href="../../Homelab/Storage/ZFS-Dataset--and--Zvol" data-for="Homelab/Storage/ZFS-Dataset--and--Zvol">ZFS Dataset &amp; Zvol</a></li><li><a href="../../Homelab/Storage/ZFS-VDEV--and--Storage" data-for="Homelab/Storage/ZFS-VDEV--and--Storage">ZFS VDEV &amp; Storage</a></li></ul></div></li><li><a href="../../Homelab/Hardware" data-for="Homelab/Hardware">Hardware</a></li><li><a href="../../Homelab/Homelab" data-for="Homelab/Homelab">Homelab</a></li></ul></div></li><li><div class="folder-outer "><ul style="padding-left:0;" class="content" data-folderul></ul></div></li></ul></div></li><li id="explorer-end"></li></ul></div></div><footer class="desktop-only"><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.4.0</a> © 2025</p><ul></ul></footer></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="../../">one137</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../../Homelab/">Homelab</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../../Homelab/Internet-Infrastructure/">Internet Infrastructure</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>Forward Proxy</a></div></nav><h1 class="article-title">Forward Proxy</h1><p show-comma="true" class="content-meta"><time datetime="2025-02-04T13:18:57.000Z">Feb 04, 2025</time></p></div></div><article class="popover-hint"><p>A forward proxy sits between users and the internet, acting as an intermediary for outbound requests. When users want to access external websites, their traffic goes through the forward proxy first. This setup allows to monitor/control internet usage, cache common requests, and mask users’ original IP addresses.</p>
<p>It is the opposite of a <a href="../../Homelab/Internet-Infrastructure/Reverse-Proxy" class="internal alias" data-slug="Homelab/Internet-Infrastructure/Reverse-Proxy">Reverse Proxy</a>.</p>
<h2 id="private-forward-proxy-to-mask-ip-addresses">Private forward proxy to mask IP addresses<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#private-forward-proxy-to-mask-ip-addresses" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>This can be used so that local network servers can all access the internet through a common IP we control. It is useful when accessing external services which use IP whitelists. It is not relevant when the servers are behind a NAT router and therefore not a setup I use in my <a href="../../Homelab/Homelab" class="internal" data-slug="Homelab/Homelab">Homelab</a>, but elsewhere.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="nginx" data-theme="github-light github-dark"><code data-language="nginx" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ...</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	# ...</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    resolver </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.1.1.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.0.0.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> valid=300s;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    resolver_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $forward_scheme {</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;~ https://&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;https&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;http&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    log_format </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fwd</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    	'[$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">time_local</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">] $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">proxy_add_x_forwarded_for</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http_user_agent</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; - status=$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sent=$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bytes_sent</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> - &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">request</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8080</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    	access_log </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/var/log/nginx/fwd-proxy.access.log fwd;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        error_log </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/var/log/nginx/fwd-proxy.error.log </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">notice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        allow </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">172.16.0.0/16; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># also restricted in the env's firewall</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        deny </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$forward_scheme://$http_host$request_uri;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Host $http_host;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_ssl_server_name </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_ssl_protocols </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TLSv1.2 TLSv1.3;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_ssl_verify </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">off</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_send_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	        proxy_read_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<h3 id="scheme-and-proxy_pass">Scheme and proxy_pass<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#scheme-and-proxy_pass" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Here, clients of the proxy connect to it through HTTP. This is ok since the proxy is on our own local network. This means the default Nginx variable <code>$scheme</code> will always be “http”, as it’s inferred from the client’s connection.</p>
<p>The thing is that we want to support both HTTP and HTTPS targets. Therefore <code>$scheme</code> cannot be used and we have to parse the target’s address to define a <code>$forward_scheme</code> (arbitrary name), which must be “https” if the target contains “https://” and “http” otherwise. This is what the <code>map</code> at the beginning does.</p>
<p>Actually it’s unfortunate Nginx doesn’t offer a variable with the full URL and the full URL only, e.g. <code>https://a.b.com:1234/xyx?m=n</code>. <code>$request</code> contains the full URL but also more, e.g. <code>POST https://a.b.com:1234/xyx?m=n HTTP/1.1</code>. So the full URL it needs to be reconstructed for <code>proxy_pass</code> using <code>$forward_scheme</code>. The other elements are <code>http_host</code> (<code>a.b.com:1234</code>) and <code>request_uri</code> (<code>/xyx?m=n</code>).</p>
<h4 id="variables">Variables<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#variables" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h4>
<p>Default variables <code>$host</code> and <code>$uri</code> are processed and potentially modified versions of <code>$http_host</code> and <code>$request_uri</code>, respectively.</p>
<p>Other useful variables include <code>$arg_{name}</code> (where <code>$arg_m</code> is <code>n</code> in the above example), <code>$content_type</code>, <code>$request_method</code>.</p>
<p><code>$http_{name}</code> are the values of arbitrary HTTP headers. For example, <code>$http_user_agent</code> is the User-Agent header (“Mozilla/5.0 …”).</p>
<p>List of Nginx http module variables: <a href="https://nginx.org/en/docs/http/ngx_http_core_module.html" class="external">https://nginx.org/en/docs/http/ngx_http_core_module.html<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>.</p>
<h3 id="ssl--tls">SSL / TLS<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#ssl--tls" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<h4 id="proxy_ssl_verify">proxy_ssl_verify<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#proxy_ssl_verify" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h4>
<p>In this scenario, the proxy acts as a normal client, initiating the HTTPS connection to the target itself, like any HTTPS client would.</p>
<p><code>proxy_ssl_verify</code> is off by default. Turning it on would be a nice security improvement. Without it, the proxy won’t verify the validity of the target’s SSL certificate, which could expose us to MITM attacks between the proxy and the target.</p>
<p>The two following options because necessary:</p>
<ul>
<li><code>proxy_ssl_trusted_certificate /path/to/ca-certificates.crt;</code>
<ul>
<li>Points to a file containing trusted CA certificates in PEM format</li>
<li>Typically points to the system’s CA bundle (like <code>/etc/ssl/certs/ca-certificates.crt</code> on Debian/Ubuntu)</li>
<li>Only needs public certificates (unlike <code>ssl_certificate</code> which needs private keys)</li>
</ul>
</li>
<li><code>proxy_ssl_verify_depth 2;</code>
<ul>
<li>Controls how many intermediate certificates are allowed in the chain</li>
<li>Default is 1, meaning: target certificate + 1 intermediate</li>
<li>Most public sites need at most depth 2</li>
</ul>
</li>
</ul>
<p>I’ve had issues making this work though and haven’t tested further. The target’s SSL certificates were incorrectly rejected by the proxy. Possibly my CA bundle was not up-to-date.</p>
<h4 id="proxy_connect">proxy_connect<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#proxy_connect" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h4>
<p>Another approach for HTTPS connections through forward proxies is to use <code>proxy_connect</code>. The TLS connection to the target is then negotiated by the client itself through a tunnel, and the proxy has no access whatsoever to the data exchanged between the two. In other words, this ensure end-to-end encryption between the client and the target.</p>
<p>In the current setup, the proxy could log everything that goes through it, and it is fine since we own and trust the proxy. <code>proxy_connect</code> is mostly useful for public forward proxies.</p>
<p>It works using an HTTP method called CONNECT, which requests to establish a TCP tunnel between the client and the target, unrelated to TLS and so before any HTTP/HTTPS traffic flows. <a href="https://stackoverflow.com/questions/11697943/when-should-one-use-connect-and-get-http-methods-at-http-proxy-server#40329026" class="external">More info<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. The proxy then just forward raw TCP bytes.</p>
<p><code>proxy_connect</code> is usually not supported by default by Nginx, which needs to be explicitly compiled with this module.</p>
<h3 id="headers-and-ips">Headers and IPs<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#headers-and-ips" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Proxies often set headers such as <code>X-Real-IP</code> and <code>X-Forwarded-For</code> and <code>X-Forwarded-Proto</code>.</p>
<p>In our case, we do <em>not</em> want to set those, because we do not want or need to expose our internal network’s architecture. As far as the target is concerned, the request comes from the proxy. The point of the setup discussed here was to only expose / whitelist the proxy’s IP.</p>
<ul>
<li><code>X-Forwarded-Proto</code> tells the target server what protocol (http/https) the client originally used.</li>
<li><code>X-Real-IP</code> is set to a single IP address that represents the original client. If there are multiple proxies in the chain, it will typically be set by the first proxy and won’t change.</li>
<li><code>X-Forwarded-For</code> is a comma-separated list of IPs showing the chain of forwarding. Each proxy appends the IP it received the request from, building a trail of all proxies involved: <code>X-Forwarded-For: client_ip, proxy1_ip, proxy2_ip</code>.</li>
</ul>
<p>As for the <code>Host</code> header, it is essential for virtual hosting - it tells the target server which website we’re trying to access when multiple sites are hosted on the same IP. Since we’re using a forward proxy with full URLs in the request URI, Nginx should extract the correct host from the URL and it might work without setting this header. However, it’s considered best practice to set <code>Host</code> explicitly to ensure consistent behavior.</p>
<h4 id="ip-spoofing">IP Spoofing<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#ip-spoofing" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h4>
<p>One simple IP spoofing technics consists of sending a fake X-Real-IP header to the target. It is therefore an Application-layer security concern.</p>
<p><code>curl https://httpbin.io/anything -H &quot;X-Real-IP: 1.1.1.1&quot;</code></p></article><hr/><div id="one137-comments"></div><script src="/comments.js"></script><div class="page-footer"></div></div><div class="right sidebar"><div class="toc desktop-only"><button type="button" id="toc" class aria-controls="toc-content" aria-expanded="true"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="toc-content" class><ul class="overflow"><li class="depth-0"><a href="#private-forward-proxy-to-mask-ip-addresses" data-for="private-forward-proxy-to-mask-ip-addresses">Private forward proxy to mask IP addresses</a></li><li class="depth-1"><a href="#scheme-and-proxy_pass" data-for="scheme-and-proxy_pass">Scheme and proxy_pass</a></li><li class="depth-1"><a href="#ssl--tls" data-for="ssl--tls">SSL / TLS</a></li><li class="depth-1"><a href="#headers-and-ips" data-for="headers-and-ips">Headers and IPs</a></li></ul></div></div><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li><a href="../../Homelab/Internet-Infrastructure/Reverse-Proxy" class="internal">Reverse Proxy</a></li></ul></div></div></div></div></body><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript"></script><script src="../../postscript.js" type="module"></script></html>